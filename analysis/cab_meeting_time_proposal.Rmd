---
title: "CAB Meeting Times"
author: "Stevie Pederson"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE,
  fig.height = 9, fig.width = 10
)
```

```{r packages}
library(timechange)
library(tidyverse)
library(ggtext)
library(pander)
panderOptions("missing", "")
panderOptions("table.split.table", Inf)
```

```{r draw-schedule}
draw_schedule <- function(
    dates, people, bus_hours = c(8, 18), upr = 23, lwr = 5,
    exec = c("Stevie", "Lori"), ...
) {
  exec_regexp <- paste0("(", paste(exec, collapse = "|"), ")")
  people %>%
    lapply(
      \(x) mutate(
        dates,
        tz = x,
        local = time_at_tz(utc, tz = x),
        time =  format(local, "%H:%M"),
        time_dbl =  hour(local) + minute(local)/60
      )
    ) %>%
    bind_rows(.id = "member") %>%
    mutate(
      member = fct(
        member,
        levels = people %>%
          lapply(\(x) now(tzone = x)) %>%
          lapply(format, "%z") %>%
          map_dbl(as.numeric) %>%
          sort() %>%
          names()
      ) %>% 
        fct_relabel(\(x) str_replace_all(x, exec_regexp, "**\\1**"))
    ) %>%
    arrange(member) %>%
    mutate(
      tz = tz %>% str_replace_all("(/)(.+)", "\n(\\2)") %>% fct_inorder(),
      status = case_when(
        time_dbl >= upr | time_dbl <= lwr ~ "Horrible",
        time_dbl >= max(bus_hours) | time_dbl < min(bus_hours) ~ "Outside Hours",
        time_dbl >= min(bus_hours) | time_dbl < max(bus_hours) ~ "Business Hours"
      ) %>%
        fct(levels = c("Horrible", "Outside Hours", "Business Hours")),
      month = fct(as.character(month), levels = month.abb[c(11:12, 1:10)])
    ) %>%
    ggplot(aes(month, member)) +
    geom_raster(aes(fill = status), alpha = 0.6) +
    geom_text(aes(label = time), size = 3) +
    facet_grid(rows = vars(tz), scales = "free", space = "free", ) +
    labs(x = c(), y = c(), fill = "Status") +
    scale_x_discrete(expand = expansion(0, 0)) +
    scale_y_discrete(expand = expansion(0, 0)) +
    scale_fill_manual(values = c("red3", "yellow3", "green3")) +
    theme_bw() +
    theme(
      legend.position = "bottom", 
      axis.text.y = element_markdown(), 
      strip.text.y = element_text(angle = 0),
      panel.spacing = unit(0, "npc"),
      panel.grid = element_blank()
    )
}
```


## Introduction

The initial proposal to shift meeting times in a rotating fashion was an attempt to be fair to all members, however, in reality there is a growing sense that the idea is not working as successfully as hoped for.
In reality, there will be no solution that works for everyone as the spread of time zones is just too diverse.
This is obviously an excellent problem to be wrangling, but it is still a significant challenge.
A set of proposed options are given below.

I've considered my understanding of standard business hours (8am to 5pm) to be the optimal time range for people, and between the hours of 11pm to 5am to be 'horrible'.
Anything between these is 'Outside of Hours', which should still be realistic times for everyone, despite them not being super-convenient.

An important consideration for each option is not only our own preferences, but the availability of Lori as both secretary and member of the Bioconductor Core Team, and the current (co-)chair Stevie.

There are three proposals given below as the probable best options for the current CAB.

1. Placing the 'horrible times' in the empty space between the furthest spread members
2. Fixing the start time at 12pm UTC for every meeting
3. Starting based on the Western-most member of each region

I also note that time-zones may not describe exactly where everyone lives, but these are chosen to match the output of `OlsonNames()` which is how `R` wrangles time-zones.
All projections have been made based on UTC time.

Feel free to play with the code in the accompanying rmarkdown. 
I kinda had fun...


\clearpage

## CAB Description

```{r people-dates}
people <- list(
  Stevie = "Australia/Adelaide",
  Lori = "America/New_York",
  Enis = "America/New_York",
  Umar = "Africa/Lagos",
  Zahraa = "America/Chicago",
  Aedin = "Europe/Dublin",
  Maria = "Europe/Dublin",
  Mengbo = "Australia/Melbourne",
  Kozo = "Asia/Tokyo",
  Tobi = "America/New_York",
  Johannes = "Europe/Rome",
  LluÃ­s = "Europe/Madrid",
  Kevin = "Europe/London",
  Eliana = "Europe/Tirane",
  Fabricio = "Europe/Brussels",
  Izabela = "America/Belem",
  Laurent = "Europe/Brussels",
  Martha = "Europe/London",
  Tuomas = "Europe/Helsinki",
  Zugang = "Europe/Berlin"
)
dates <- tibble(
  date = ymd("20251001") + seq(0, 365),
  weekday = wday(date, label = TRUE),
  month = month(date, label = TRUE),
  exists = TRUE
) %>%
  mutate(
    nbr = cumsum(exists), .by = c(month, weekday)
  ) %>%
  dplyr::filter(
    weekday == "Thu", nbr == 2
  ) %>%
  droplevels() %>% 
  dplyr::select(date, month)
```


As it currently stands, the CAB contains `r length(people)` members, spread across `r length(unique(unlist(people)))` time-zones, with these broken down and grouped in the following table.

```{r cab-summary-tbl}
people %>% 
  unlist() %>% 
  enframe(name = "member", value = "tz") %>% 
  mutate(
    current_utc = tz %>% 
      lapply(
        \(x) now(tzone = x)
      ) %>% 
      map_chr(format, "%z"),
    future_utc = tz %>% 
      lapply(
        \(x) time_at_tz(now() + 9 * 30 * 24*60 * floor(365/4), x)
      ) %>% 
      map_chr(format, "%z")
  ) %>% 
  arrange(as.numeric(current_utc), as.numeric(future_utc)) %>% 
  chop(all_of(c("member", "tz")))%>% 
  # chop(member) %>% 
  mutate(
    current_utc = str_replace(current_utc, "(.+)([0-9]{2})$", "\\1:\\2"),
    future_utc = str_replace(future_utc, "(.+)([0-9]{2})$", "\\1:\\2"),
    n = map_int(member, length),
    member = map_chr(member, paste, collapse = ", "),
    tz = map_chr(tz, \(x) paste(unique(x), collapse = ", "))
  ) %>% 
  dplyr::select(member, tz, n, ends_with("utc")) %>% 
  rename_with(
    \(x) x %>% str_to_title() %>% str_replace_all("_utc", " UTC") %>% str_replace("Tz", "TZ")
  ) %>% 
  pander(
    justify = "llrlr",
    caption = "
    Breakdown of all time zones with the current +UTC shift and where that shift will be 9 months into the future.
    The largest 'empty space' time period is between the US/Chicago & Australia/Melbourne, with no members in the time-zones between the two.
    For Apr-Sep this is 9hrs ($\\pm 1$ day), whilst for Nov-Feb this will be 7 hours.
    The other large time gaps are between 1: Helsinki & Tokyo, and, 2: Dublin/London and the US East Coast.
    "
  )
```



```{r tbl-empty-space}
dates %>% 
  mutate(
    date = as_datetime(date),
    `US/Central` = time_at_tz(date, "America/Chicago"),
    `Australia/Melbourne` = time_at_tz(date, "Australia/Melbourne"),
    `Europe/Helsinki` = time_at_tz(date, "Europe/Helsinki"),
    `Asia/Tokyo` = time_at_tz(date, "Asia/Tokyo")
  ) %>% 
  mutate(
    `US/Central` = hour(`US/Central`) + minute(`US/Central`) / 60,
    `Australia/Melbourne` = hour(`Australia/Melbourne`) + minute(`Australia/Melbourne`) / 60,
    `Europe/Helsinki` = hour(`Europe/Helsinki`) + minute(`Europe/Helsinki`) / 60,
    `Asia/Tokyo` = hour(`Asia/Tokyo`) + minute(`Asia/Tokyo`) / 60,
    pacific_diff = abs(`Australia/Melbourne` - `US/Central`),
    contintental_diff = abs(`Asia/Tokyo` - `Europe/Helsinki`)
  ) %>% 
  dplyr::select(date, month, ends_with("diff")) %>% 
  mutate(
    `place_1-4am_in` = ifelse(pacific_diff > contintental_diff, "Pacific Ocean", "Helsinki-Asia")
  ) %>% 
  rename_with(\(x) x %>% str_replace_all("_", " ") %>% str_to_title()) %>% 
  pander(
    justify = "llrrl",
    caption = "
    Taking the two largest 'empty-space' regions, where no participants live, 
    and looking for the time differences.
    Time-zone differences between the US/Central & Melbourne are given as 'Pacific Diff', 
    whilst those between Europe/Helsinki and Asia/Tokyo are given as 'Contintental Diff'.
    ",
    emphasize.italics.rows = which(.$`Pacific Diff` == .$`Contintental Diff`)
  )
```
\clearpage

## Proposal One: Placing Difficult Times In The Empty Space

The strategy attempted here is to find the 'empty' region on the planet at each given month, where no CAB members are located, which contains the longest duration relative to *everyone's lived time-zone*.
If we place the difficult middle-of-the-night meeting times in these empty regions, the hoped for outcome will be the fewest CAB members having to endure middle-of-the-night meetings.
Of course, the CAB contains a mix of 'morning people' and 'night-owls', making this a a near impossible challenge, however, if we assume somewhere between 1-4am should be placed in the centre of these empty regions, this might be the best starting point.

For March to October, the best region to place the middle-of-the-night times is in the Pacific Ocean with an 8-9hr difference.
For the other times, the best region to place these is between the most eastern European time-zone (Helsinki) and western Asian time-zone (Tokyo) with a 7hr time difference.


```{r make-prop1-schedule,  fig.cap = "Proposed schedule placing the largest time regions without members into the middle of the night"}
p <- dates %>% 
  mutate(
    utc = case_when(
      # month %in% c("Jan", "Feb", "Nov", "Dec") ~ as_datetime(date + 7/24),
      month %in% c("Jan", "Feb", "Nov", "Dec") ~ as_datetime(date + 21/24),
      TRUE ~ as_datetime(date + 12/24)
    )
  ) %>% 
  draw_schedule(people)
p
```

`r pander(table(p@data$status))`

Key points:

- No-one has a meeting starting anywhere between 12am and 5am, however
    - Kozo will have `r nrow(p@data %>% dplyr::filter(member == "Kozo", time_dbl == 6))` meetings scheduled at 6am
    - Tuomas will have `r nrow(p@data %>% dplyr::filter(member == "Tuomas", time_dbl == 23))` meetings at 11pm
    - Mengbo has `r nrow(p@data %>% dplyr::filter(member == "Mengbo", time_dbl == 23))` meeting at 11pm
- People near the edges of the empty-space are disadvantaged
    - Most of Europe/Africa and the Asia/Pacific are inconvenient for Nov through Mar
    - US/Central, Australia/Melbourne and Japan are inconvenient for Apr to Oct


```{r tbl-horrible}
p@data %>% 
  summarise(
    `After 11pm` = sum(time == "00:00" | time_dbl >= 23),
    `6am Or Earlier` = sum(time_dbl <= 6 & time_dbl > 0),
    .by = member
  ) %>% 
  dplyr::filter(
    rowSums(.[-1]) > 0
  ) %>% 
  bind_rows(
    summarise(.[-1], across(everything(), sum)) %>% mutate(member = "Total")
  ) %>% 
  mutate(
    member = str_remove_all(member, "\\*"),
    TZ = unlist(people)[member],
    `Combined Problematic` = `After 11pm` + `6am Or Earlier` 
  ) %>% 
  dplyr::select(Member = member, TZ, everything()) %>% 
  pander(
    justify = "llrrr",
    emphasize.strong.rows = which(str_detect(.$Member, "Total")),
    caption = "
    Summary of members with the most problematic meeting times,
    even after avoiding the 1am to 5am timezone. 
    These members are the most disadvantaged by this proposal
    "
  )
```


```{r export-empty, echo=FALSE}
write_rds(p, here::here("data", "empty_space.rds"), compress = "gz")
```


\clearpage

## Proposal Two: Fix Times at 12pm UTC

This effectively places the horrible meeting times between Australia/Melbourne and America/Chicago for the entire year.

Key Points:

- This is good for the key members Lori & Stevie
- **Strongly disadvantages Mengbo**
- Possibly workable but also inconvenient for Kozo & Zahraa
- Offers the highest number of meetings scheduled during business hours

```{r schedule-ny-fixed, fig.cap = "Proposed meeting times holding the start time fixed at 12pm UTC"}
p <- dates %>% 
  mutate(
    utc = case_when(
      # month %in% c("Jan", "Feb", "Nov", "Dec") ~ as_datetime(date + 12/24),
      TRUE ~ as_datetime(date + 12/24)
    )
  ) %>% 
  draw_schedule(people)
p
```


`r pander(table(p@data$status))`

```{r tbl-horrible2}
p@data %>% 
  summarise(
    `After 11pm` = sum(time == "00:00" | time_dbl >= 23),
    `6am Or Earlier` = sum(time_dbl <= 6 & time_dbl > 0),
    .by = member
  ) %>% 
  dplyr::filter(
    rowSums(.[-1]) > 0
  ) %>% 
  bind_rows(
    summarise(.[-1], across(everything(), sum)) %>% mutate(member = "Total")
  ) %>% 
  mutate(
    member = str_remove_all(member, "\\*"),
    TZ = unlist(people)[member],
    `Combined Problematic` = `After 11pm` + `6am Or Earlier` 
  ) %>% 
  dplyr::select(Member = member, TZ, everything()) %>% 
  pander(
    justify = "llrrr",
    emphasize.strong.rows = which(str_detect(.$Member, "Total")),
    caption = "
    Summary of members with the most problematic meeting times,
    if holding the start time fixed for US/Eastern. 
    These members are the most disadvantaged by this proposal
    "
  )
```

```{r export-ny-fixed, echo=FALSE}
write_rds(p, here::here("data", "ny_fixed.rds"), compress = "gz")
```

\clearpage

## Proposal Three: Start Times Based On The Western-Most Member

This is a *slightly modified version of an earlier approach*, where meetings shift every 4 months. 
For each block, we take the western-most member from each of Asia, Europe & the US as the key member.
We then start meeting times *at 7, 8 or 9am for that member* to best accommodate other regions, and ensuring at least two larger regions have workable times.

1. 6am starts for Kozo (Asia).
2. 7am starts for Zahraa (US).
3. 8am starts for Western Europe

- Everyone gets at least 4 meetings in standard business hours except Stevie (8am to 5pm as shown in green)
- No-one has more than 4 'horrible' meeting times (11pm to 5am)
- For Apr to June, it's conceivable for the entire board to attend.
- *This is unsatisfactory for Lori as an office-holder*

```{r schedule-western, fig.cap = "Proposed rotating meeting schedule, setting the start time for the western-most member of each region. 1) Aug-Nov favour Europe & Asia, 2) Apr-July favour the US & Europe, whilst 3) Dec-Mar favours Asia & the US"}
p <- dates %>% 
  mutate(
    utc = case_when(
      month %in% c("Apr", "May", "Jun", "Jul") ~ as_datetime(date + 12/24),
      month %in% c("Aug", "Sep", "Oct") ~ as_datetime(date + 7/24),
      month %in% c("Nov") ~ as_datetime(date + 8/24),
      TRUE ~ as_datetime(date + 21/24)
    )
  ) %>% 
  draw_schedule(people)
p
```

`r pander(table(p@data$status))`

```{r tbl-horrible3}
p@data %>% 
  summarise(
    `After 11pm` = sum(time == "00:00" | time_dbl >= 23),
    `6am Or Earlier` = sum(time_dbl <= 6 & time_dbl > 0),
    .by = member
  ) %>% 
  dplyr::filter(
    rowSums(.[-1]) > 0
  ) %>% 
  bind_rows(
    summarise(.[-1], across(everything(), sum)) %>% mutate(member = "Total")
  ) %>% 
  mutate(
    member = str_remove_all(member, "\\*"),
    TZ = unlist(people)[member],
    `Combined Problematic` = `After 11pm` + `6am Or Earlier` 
  ) %>% 
  dplyr::select(Member = member, TZ, everything()) %>% 
  pander(
    justify = "llrrr",
    emphasize.strong.rows = which(str_detect(.$Member, "Total")),
    caption = "
    Summary of members with the most problematic meeting times,
    if holding the start time fixed for the most western member of each region. 
    These members are the most disadvantaged by this proposal
    "
  )
```

```{r export-western, echo=FALSE}
write_rds(p, here::here("data", "western.rds"), compress = "gz")
```


## Proposal Four: Favouring Two Time Zones

This proposal sets the start time at 7am for the earliest member favouring:

1. Europe, Africa & the Asia-Pacific
2. The Americas, Europe & Africa


```{r make-prop4-schedule,  fig.cap = "Proposed schedule favouring two regions siultaneously"}
p <- dates %>% 
  mutate(
    utc = case_when(
      month %in% c("Jan", "Feb", "Nov", "Dec") ~ as_datetime(date + 7/24),
      # month %in% c("Jan", "Feb", "Nov", "Dec") ~ as_datetime(date + 21/24),
      TRUE ~ as_datetime(date + 12/24)
    )
  ) %>% 
  draw_schedule(people)
p
```

`r pander(table(p@data$status))`

Key points:

- Those in the Americas will find it hard to attend Nov-Feb. This includes Lori as a key member


```{r tbl-horrible4}
p@data %>% 
  summarise(
    `After 11pm` = sum(time == "00:00" | time_dbl >= 23),
    `6am Or Earlier` = sum(time_dbl <= 6 & time_dbl > 0),
    .by = member
  ) %>% 
  dplyr::filter(
    rowSums(.[-1]) > 0
  ) %>% 
  bind_rows(
    summarise(.[-1], across(everything(), sum)) %>% mutate(member = "Total")
  ) %>% 
  mutate(
    member = str_remove_all(member, "\\*"),
    TZ = unlist(people)[member],
    `Combined Problematic` = `After 11pm` + `6am Or Earlier` 
  ) %>% 
  dplyr::select(Member = member, TZ, everything()) %>% 
  pander(
    justify = "llrrr",
    emphasize.strong.rows = which(str_detect(.$Member, "Total")),
    caption = "
    Summary of members with the most problematic meeting times,
    even after avoiding the 1am to 5am timezone. 
    These members are the most disadvantaged by this proposal
    "
  )
```


```{r export-favour2, echo=FALSE}
write_rds(p, here::here("data", "favouring_two.rds"), compress = "gz")
```


\clearpage
